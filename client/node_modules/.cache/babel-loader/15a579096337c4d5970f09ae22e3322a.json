{"ast":null,"code":"import _slicedToArray from\"/Users/max/dev/listening-party/client/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useState}from'react';import{SocketEvent}from'../common';import axios from'axios';import{useHistory}from'react-router';import{useUser}from'../contexts/UserContext';import socket from'../socket';import{SPOTIFY_API}from'../const';import'./Party.css';var imageStyle={// width: '100vw',\nheight:'300px'};var Player=function Player(_ref){var playback=_ref.playback;return/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"h3\",null,\"Playing \",playback===null||playback===void 0?void 0:playback.item.name,\" by \",playback===null||playback===void 0?void 0:playback.item.album.artists[0].name),/*#__PURE__*/React.createElement(\"img\",{style:imageStyle,src:playback.item.album.images[0].url}),/*#__PURE__*/React.createElement(\"h3\",null,playback.is_playing?'Playing':'Paused'));};var UserAvatar=function UserAvatar(_ref2){var user=_ref2.user;return/*#__PURE__*/React.createElement(\"span\",{className:\"avatar mr-2\"},user.images.length>0?/*#__PURE__*/React.createElement(\"img\",{className:\"avatar__img\",src:user.images[0].url}):/*#__PURE__*/React.createElement(\"span\",{className:\"avatar__placeholder\"},/*#__PURE__*/React.createElement(\"span\",{className:\"avatar__placeholder__letter\"},user.display_name.substr(0,1))),/*#__PURE__*/React.createElement(\"span\",null,user.display_name));};var PartyPage=function PartyPage(_ref3){var _currentParty$adminUs,_currentParty$adminUs2,_currentParty$users;var match=_ref3.match;var _useUser=useUser(),user=_useUser.user,isLoading=_useUser.isLoading;var _useState=useState(undefined),_useState2=_slicedToArray(_useState,2),currentParty=_useState2[0],setCurrentParty=_useState2[1];var partyId=match.params.id;var history=useHistory();var pollCurrentlyPlaying;var currentPartyRef=React.useRef(currentParty);// this is so that the socket io handler methods get the latest version of currentParty\nuseEffect(function(){currentPartyRef.current=currentParty;},[currentParty]);useEffect(function(){// NEED TO CHECK IF PARTY EXISTS HERE \nreturn function(){return handleUserLeaving();};},[]);var registerListeners=function registerListeners(){socket.on(SocketEvent.USER_LEFT_PARTY_RES,onUserLeftParty);socket.on(SocketEvent.PARTY_PLAYBACK_CHANGED_RES,onPlaybackChanged);socket.on(SocketEvent.PARTY_NOT_FOUND_RES,onPartyNotFound);socket.on(SocketEvent.PARTY_NEW_USER_JOINED_RES,onNewUserJoined);socket.on(SocketEvent.PARTY_JOINED_RES,onPartyJoined);socket.on(SocketEvent.PARTY_CHANGED_ADMIN_RES,onAdminChanged);};useEffect(function(){if(!user||isLoading){if(!isLoading){console.log('You are not authed');}return;}console.log('Logged in as ',user.display_name);registerListeners();socket.emit(SocketEvent.PARTY_JOINED_REQ,{user:user,socketId:socket.id,partyId:partyId});},[user]);var onUserLeftParty=function onUserLeftParty(party){console.log('A user left party.');setCurrentParty(party);};var onPlaybackChanged=function onPlaybackChanged(party){var _party$adminUser;console.log('Playback state updated.');var isAdminUser=((_party$adminUser=party.adminUser)===null||_party$adminUser===void 0?void 0:_party$adminUser.id)===(user===null||user===void 0?void 0:user.id);if(!isAdminUser&&party.playbackState){var _currentPartyRef$curr,_currentPartyRef$curr2,_currentPartyRef$curr3,_currentPartyRef$curr4,_currentPartyRef$curr5,_currentPartyRef$curr6;var isNowPlaying=party.playbackState.is_playing&&!((_currentPartyRef$curr=currentPartyRef.current)===null||_currentPartyRef$curr===void 0?void 0:(_currentPartyRef$curr2=_currentPartyRef$curr.playbackState)===null||_currentPartyRef$curr2===void 0?void 0:_currentPartyRef$curr2.is_playing);//false\nvar isNowPaused=!party.playbackState.is_playing&&((_currentPartyRef$curr3=currentPartyRef.current)===null||_currentPartyRef$curr3===void 0?void 0:(_currentPartyRef$curr4=_currentPartyRef$curr3.playbackState)===null||_currentPartyRef$curr4===void 0?void 0:_currentPartyRef$curr4.is_playing);//undefined\nvar isNewSong=((_currentPartyRef$curr5=currentPartyRef.current)===null||_currentPartyRef$curr5===void 0?void 0:(_currentPartyRef$curr6=_currentPartyRef$curr5.playbackState)===null||_currentPartyRef$curr6===void 0?void 0:_currentPartyRef$curr6.item.id)!==party.playbackState.item.id;//false\nif(isNowPlaying||isNewSong){playSong(party.playbackState,true);}else if(isNowPaused){pauseSong();}}setCurrentParty(party);};var onNewUserJoined=function onNewUserJoined(party){var _party$users;console.log('New user joined,',party.users?party.users[((_party$users=party.users)===null||_party$users===void 0?void 0:_party$users.length)-1].display_name:'');setCurrentParty(party);};var onPartyNotFound=function onPartyNotFound(){console.log('This party was not found... redirecting back');setTimeout(function(){history.push('/');},2000);};var onPartyJoined=function onPartyJoined(party){setCurrentParty(party);if(party.playbackState&&party.playbackState.is_playing){playSong(party.playbackState,true);}};var onAdminChanged=function onAdminChanged(party){var _currentPartyRef$curr7,_currentPartyRef$curr8,_party$adminUser2;var wasPreviouslyAdmin=((_currentPartyRef$curr7=currentPartyRef.current)===null||_currentPartyRef$curr7===void 0?void 0:(_currentPartyRef$curr8=_currentPartyRef$curr7.adminUser)===null||_currentPartyRef$curr8===void 0?void 0:_currentPartyRef$curr8.id)===(user===null||user===void 0?void 0:user.id);if(((_party$adminUser2=party.adminUser)===null||_party$adminUser2===void 0?void 0:_party$adminUser2.id)===(user===null||user===void 0?void 0:user.id)&&!wasPreviouslyAdmin){console.log('Youve been assigned admin.');clearInterval(pollCurrentlyPlaying);getCurrentlyPlaying(party.id);pollCurrentlyPlaying=setInterval(function(){getCurrentlyPlaying(party.id);},10000);}setCurrentParty(party);};var handleUserLeaving=function handleUserLeaving(){socket.off(SocketEvent.USER_LEFT_PARTY_RES,onUserLeftParty);socket.off(SocketEvent.PARTY_PLAYBACK_CHANGED_RES,onPlaybackChanged);socket.off(SocketEvent.PARTY_NOT_FOUND_RES,onPartyNotFound);socket.off(SocketEvent.PARTY_NEW_USER_JOINED_RES,onNewUserJoined);socket.off(SocketEvent.PARTY_JOINED_RES,onPartyJoined);socket.off(SocketEvent.PARTY_CHANGED_ADMIN_RES,onAdminChanged);console.log('Leaving party.');clearInterval(pollCurrentlyPlaying);socket.emit(SocketEvent.USER_LEFT_PARTY_REQ,{userId:user===null||user===void 0?void 0:user.id,partyId:partyId});};var playSong=function playSong(playbackState){var isFirstTime=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;console.log('setting currently playing...');var args={uris:[playbackState.item.uri],position_ms:isFirstTime?playbackState.progress_ms:0};axios.put(SPOTIFY_API.PLAY,args).then(function(){return console.log('Playing new song: ',playbackState.item.name);}).catch(function(err){var error=err.response.data.error;if(error.reason===\"NO_ACTIVE_DEVICE\"){console.log('Could not play song. No active device found.');}else if(error.reason===\"PREMIUM_REQUIRED\"){console.log('Could not play song. Premium required.');}else{console.log('Could not play song. Error: ',error);}});};var pauseSong=function pauseSong(){axios.put(SPOTIFY_API.PAUSE).then(function(){return console.log('Paused song.');}).catch(function(err){var error=err.response.data.error;console.log('Could not pause song: ',error);});};var getCurrentlyPlaying=function getCurrentlyPlaying(partyId){console.log('Getting currently playing...');axios.get(SPOTIFY_API.CURRENTLY_PLAYING).then(function(res){if(!res.data||!res.data.item){console.log('Nothing is playing, its an ad, or you are in private mode.');return;}socket.emit(SocketEvent.PARTY_PLAYBACK_REQ,{playbackState:res.data,partyId:partyId});}).catch(function(err){console.log('could not get currently playing');});};// const onPartyJoinedUnauthed = (numberOfUsers: number) => {\n//     console.log('PARTY JOINED BACK')\n//     setNumberOfUsers(numberOfUsers);\n// }\nreturn/*#__PURE__*/React.createElement(\"div\",null,user&&user.id?/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"h2\",null,\"Welcome to the party \",user.display_name,\" \\uD83C\\uDF89\"),/*#__PURE__*/React.createElement(\"h2\",{className:\"subheading mb-2\"},(currentParty===null||currentParty===void 0?void 0:(_currentParty$adminUs=currentParty.adminUser)===null||_currentParty$adminUs===void 0?void 0:_currentParty$adminUs.display_name)===user.display_name?'You are the DJ.':\"Your DJ is \".concat(currentParty===null||currentParty===void 0?void 0:(_currentParty$adminUs2=currentParty.adminUser)===null||_currentParty$adminUs2===void 0?void 0:_currentParty$adminUs2.display_name)),(currentParty===null||currentParty===void 0?void 0:currentParty.playbackState)?/*#__PURE__*/React.createElement(Player,{playback:currentParty.playbackState}):/*#__PURE__*/React.createElement(\"div\",null,\"No tracks playing\"),/*#__PURE__*/React.createElement(\"h2\",null,\"People in the party are\"),/*#__PURE__*/React.createElement(\"div\",{className:\"users\"},currentParty===null||currentParty===void 0?void 0:(_currentParty$users=currentParty.users)===null||_currentParty$users===void 0?void 0:_currentParty$users.map(function(user){return/*#__PURE__*/React.createElement(UserAvatar,{key:user.id,user:user});}))):/*#__PURE__*/React.createElement(\"div\",null,\"This is a party, but you aint authed.\"));};export default PartyPage;","map":{"version":3,"sources":["/Users/max/dev/listening-party/client/src/pages/Party.tsx"],"names":["React","useEffect","useState","SocketEvent","axios","useHistory","useUser","socket","SPOTIFY_API","imageStyle","height","Player","playback","item","name","album","artists","images","url","is_playing","UserAvatar","user","length","display_name","substr","PartyPage","match","isLoading","undefined","currentParty","setCurrentParty","partyId","params","id","history","pollCurrentlyPlaying","currentPartyRef","useRef","current","handleUserLeaving","registerListeners","on","USER_LEFT_PARTY_RES","onUserLeftParty","PARTY_PLAYBACK_CHANGED_RES","onPlaybackChanged","PARTY_NOT_FOUND_RES","onPartyNotFound","PARTY_NEW_USER_JOINED_RES","onNewUserJoined","PARTY_JOINED_RES","onPartyJoined","PARTY_CHANGED_ADMIN_RES","onAdminChanged","console","log","emit","PARTY_JOINED_REQ","socketId","party","isAdminUser","adminUser","playbackState","isNowPlaying","isNowPaused","isNewSong","playSong","pauseSong","users","setTimeout","push","wasPreviouslyAdmin","clearInterval","getCurrentlyPlaying","setInterval","off","USER_LEFT_PARTY_REQ","userId","isFirstTime","args","uris","uri","position_ms","progress_ms","put","PLAY","then","catch","err","error","response","data","reason","PAUSE","get","CURRENTLY_PLAYING","res","PARTY_PLAYBACK_REQ","map"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react';\nimport { SocketEvent, Party, PlaybackState } from '../common';\nimport axios, { AxiosResponse } from 'axios';\nimport { match, useHistory } from 'react-router';\n\nimport { useUser } from '../contexts/UserContext';\nimport socket from '../socket';\nimport { User } from '../common';\nimport { SPOTIFY_API } from '../const';\nimport './Party.css'\n\ninterface Props {\n    match: any;\n}\n\nconst imageStyle = {\n    // width: '100vw',\n    height: '300px'\n}\n\nconst Player: React.FC<{ playback: PlaybackState }> = ({ playback }): React.ReactElement => {\n    return (\n        <div>\n            <h3>Playing {playback?.item.name} by {playback?.item.album.artists[0].name}</h3>\n            <img style={imageStyle} src={playback.item.album.images[0].url}></img>\n            <h3>{playback.is_playing ? 'Playing' : 'Paused'}</h3>\n        </div>\n    )\n};\n\nconst UserAvatar: React.FC<{ user: User }> = ({ user }): React.ReactElement => {\n    return <span className=\"avatar mr-2\">\n        {user.images.length > 0 ?\n            <img className=\"avatar__img\" src={user.images[0].url}></img>\n            :\n            <span className=\"avatar__placeholder\">\n                <span className=\"avatar__placeholder__letter\">{user.display_name.substr(0,1)}</span>\n                \n            </span>\n        }\n        <span>{user.display_name}</span>\n    </span>\n};\n\nconst PartyPage: React.FC<Props> = ({ match }): React.ReactElement => {\n    const { user, isLoading } = useUser();\n    const [currentParty, setCurrentParty] = useState<Party | undefined>(undefined);\n    const partyId = match.params.id;\n    const history = useHistory();\n    let pollCurrentlyPlaying: any;\n\n    const currentPartyRef = React.useRef(currentParty);\n\n    // this is so that the socket io handler methods get the latest version of currentParty\n    useEffect(() => {\n        currentPartyRef.current = currentParty;\n    }, [currentParty])\n\n    useEffect(() => {\n        // NEED TO CHECK IF PARTY EXISTS HERE \n        return () => handleUserLeaving();\n    }, [])\n\n    const registerListeners = () => {\n        socket.on(SocketEvent.USER_LEFT_PARTY_RES, onUserLeftParty);\n        socket.on(SocketEvent.PARTY_PLAYBACK_CHANGED_RES, onPlaybackChanged);\n        socket.on(SocketEvent.PARTY_NOT_FOUND_RES, onPartyNotFound);\n        socket.on(SocketEvent.PARTY_NEW_USER_JOINED_RES, onNewUserJoined);\n        socket.on(SocketEvent.PARTY_JOINED_RES, onPartyJoined);\n        socket.on(SocketEvent.PARTY_CHANGED_ADMIN_RES, onAdminChanged);\n    }\n\n    useEffect(() => {\n        if (!user || isLoading) {\n            if (!isLoading) {\n                console.log('You are not authed');\n            }\n            return;\n        }\n\n        console.log('Logged in as ', user.display_name);\n\n        registerListeners();\n        socket.emit(SocketEvent.PARTY_JOINED_REQ, { user: user, socketId: socket.id, partyId: partyId })\n    }, [user])\n\n\n\n    const onUserLeftParty = (party: Party) => {\n        console.log('A user left party.');\n        setCurrentParty(party);\n    }\n\n    const onPlaybackChanged = (party: Party) => {\n        console.log('Playback state updated.');\n        const isAdminUser = party.adminUser?.id === user?.id;\n        if (!isAdminUser && party.playbackState) {\n\n            const isNowPlaying = party.playbackState.is_playing && !currentPartyRef.current?.playbackState?.is_playing; //false\n            const isNowPaused = !party.playbackState.is_playing && currentPartyRef.current?.playbackState?.is_playing;//undefined\n            const isNewSong = currentPartyRef.current?.playbackState?.item.id !== party.playbackState.item.id; //false\n\n            if (isNowPlaying || isNewSong) {\n                playSong(party.playbackState, true);\n            } else if (isNowPaused) {\n                pauseSong();\n            }\n        }\n\n        setCurrentParty(party);\n    }\n\n    const onNewUserJoined = (party: Party) => {\n        console.log('New user joined,', party.users ? party.users[party.users?.length - 1].display_name : '');\n        setCurrentParty(party);\n    }\n\n    const onPartyNotFound = () => {\n        console.log('This party was not found... redirecting back');\n        setTimeout(() => {\n            history.push('/');\n        }, 2000);\n    }\n\n    const onPartyJoined = (party: Party) => {\n        setCurrentParty(party);\n        if (party.playbackState && party.playbackState.is_playing) {\n            playSong(party.playbackState, true);\n        }\n    }\n\n    const onAdminChanged = (party: Party) => {\n        const wasPreviouslyAdmin = currentPartyRef.current?.adminUser?.id === user?.id;\n\n        if ((party.adminUser?.id === user?.id) && !wasPreviouslyAdmin) {\n            console.log('Youve been assigned admin.')\n            clearInterval(pollCurrentlyPlaying);\n            getCurrentlyPlaying(party.id);\n            pollCurrentlyPlaying = setInterval(() => {\n                getCurrentlyPlaying(party.id);\n            }, 10000);\n        }\n        setCurrentParty(party);\n    }\n\n    const handleUserLeaving = () => {\n        socket.off(SocketEvent.USER_LEFT_PARTY_RES, onUserLeftParty);\n        socket.off(SocketEvent.PARTY_PLAYBACK_CHANGED_RES, onPlaybackChanged);\n        socket.off(SocketEvent.PARTY_NOT_FOUND_RES, onPartyNotFound);\n        socket.off(SocketEvent.PARTY_NEW_USER_JOINED_RES, onNewUserJoined);\n        socket.off(SocketEvent.PARTY_JOINED_RES, onPartyJoined);\n        socket.off(SocketEvent.PARTY_CHANGED_ADMIN_RES, onAdminChanged);\n\n        console.log('Leaving party.')\n\n        clearInterval(pollCurrentlyPlaying);\n        socket.emit(SocketEvent.USER_LEFT_PARTY_REQ, { userId: user?.id, partyId: partyId })\n    }\n\n    const playSong = (playbackState: PlaybackState, isFirstTime = false) => {\n        console.log('setting currently playing...');\n\n        const args = {\n            uris: [playbackState.item.uri],\n            position_ms: isFirstTime ? playbackState.progress_ms : 0\n        }\n        axios.put(SPOTIFY_API.PLAY, args)\n            .then(() => console.log('Playing new song: ', playbackState.item.name))\n            .catch(err => {\n                const error = err.response.data.error;\n                if (error.reason === \"NO_ACTIVE_DEVICE\") {\n                    console.log('Could not play song. No active device found.')\n                } else if (error.reason === \"PREMIUM_REQUIRED\") {\n                    console.log('Could not play song. Premium required.')\n                } else {\n                    console.log('Could not play song. Error: ', error);\n                }\n            });\n    }\n\n    const pauseSong = () => {\n        axios.put(SPOTIFY_API.PAUSE)\n            .then(() => console.log('Paused song.'))\n            .catch(err => {\n                const error = err.response.data.error;\n                console.log('Could not pause song: ', error)\n            });\n    }\n\n    const getCurrentlyPlaying = (partyId: string) => {\n        console.log('Getting currently playing...');\n        axios.get(SPOTIFY_API.CURRENTLY_PLAYING)\n            .then((res: AxiosResponse<PlaybackState>) => {\n                if (!res.data || !res.data.item) {\n                    console.log('Nothing is playing, its an ad, or you are in private mode.');\n                    return;\n                }\n                socket.emit(SocketEvent.PARTY_PLAYBACK_REQ, { playbackState: res.data, partyId: partyId })\n            })\n            .catch(err => { console.log('could not get currently playing') })\n    }\n\n\n\n\n    // const onPartyJoinedUnauthed = (numberOfUsers: number) => {\n    //     console.log('PARTY JOINED BACK')\n    //     setNumberOfUsers(numberOfUsers);\n    // }\n\n    return (\n        <div>\n            {user && user.id ?\n                <div>\n                    <h2>Welcome to the party {user.display_name} 🎉</h2>\n                    <h2 className=\"subheading mb-2\">{currentParty?.adminUser?.display_name === user.display_name ? 'You are the DJ.' : `Your DJ is ${currentParty?.adminUser?.display_name}`}</h2>\n                    {currentParty?.playbackState ?\n                        <Player playback={currentParty.playbackState} />\n                        :\n                        <div>No tracks playing</div>\n                    }\n                    <h2>People in the party are</h2>\n                    <div className=\"users\">{currentParty?.users?.map(user => <UserAvatar key={user.id} user={user} />)}</div>\n                </div>\n                :\n                <div>This is a party, but you aint authed.</div>}\n        </div>);\n\n};\n\nexport default PartyPage;\n\n\n"]},"metadata":{},"sourceType":"module"}