{"ast":null,"code":"var _jsxFileName = \"/Users/max/dev/listening-party/client/src/pages/Party.tsx\";\nimport React, { useEffect, useState } from 'react';\nimport { SocketEvent } from '../common';\nimport axios from 'axios';\nimport { useHistory } from 'react-router';\nimport { useUser } from '../contexts/UserContext';\nimport socket from '../socket';\nimport { SPOTIFY_API } from '../const';\nconst imageStyle = {\n  width: '100vw',\n  height: 'auto'\n};\n\nconst PartyPage = ({\n  match\n}) => {\n  var _currentParty$adminUs, _currentParty$users, _currentParty$playbac4, _currentParty$playbac5;\n\n  const {\n    user,\n    isLoading\n  } = useUser();\n  const [currentParty, setCurrentParty] = useState(undefined);\n  const partyId = match.params.id;\n  const history = useHistory();\n  let pollCurrentlyPlaying;\n  useEffect(() => {\n    // NEED TO CHECK IF PARTY EXISTS HERE \n    return () => handleUserLeaving();\n  }, []);\n\n  const registerListeners = () => {\n    socket.on(SocketEvent.USER_LEFT_PARTY_RES, onUserLeftParty);\n    socket.on(SocketEvent.PARTY_PLAYBACK_CHANGED_RES, onPlaybackChanged);\n    socket.on(SocketEvent.PARTY_NOT_FOUND_RES, onPartyNotFound);\n    socket.on(SocketEvent.PARTY_NEW_USER_JOINED_RES, onNewUserJoined);\n    socket.on(SocketEvent.PARTY_JOINED_RES, onPartyJoined);\n    socket.on(SocketEvent.PARTY_CHANGED_ADMIN_RES, onAdminChanged);\n  };\n\n  useEffect(() => {\n    console.log('user useEffect');\n\n    if (!user || isLoading) {\n      if (!isLoading) {\n        console.log('You are not authed');\n      }\n\n      return;\n    }\n\n    console.log('Logged in as ', user.display_name);\n    registerListeners();\n    socket.emit(SocketEvent.PARTY_JOINED_REQ, {\n      user: user,\n      socketId: socket.id,\n      partyId: partyId\n    });\n  }, [user]);\n\n  const onUserLeftParty = party => {\n    console.log('A user left party.');\n    setCurrentParty(party);\n  };\n\n  const onPlaybackChanged = party => {\n    var _party$adminUser;\n\n    console.log('Playback state changed.');\n    const isAdminUser = ((_party$adminUser = party.adminUser) === null || _party$adminUser === void 0 ? void 0 : _party$adminUser.id) === (user === null || user === void 0 ? void 0 : user.id);\n\n    if (!isAdminUser && party.playbackState) {\n      var _currentParty$playbac, _currentParty$playbac2, _currentParty$playbac3;\n\n      console.log(currentParty === null || currentParty === void 0 ? void 0 : currentParty.playbackState);\n      console.log(party.playbackState);\n      const isNowPlaying = party.playbackState.is_playing && !(currentParty === null || currentParty === void 0 ? void 0 : (_currentParty$playbac = currentParty.playbackState) === null || _currentParty$playbac === void 0 ? void 0 : _currentParty$playbac.is_playing); //false\n\n      const isNowPaused = !party.playbackState.is_playing && (currentParty === null || currentParty === void 0 ? void 0 : (_currentParty$playbac2 = currentParty.playbackState) === null || _currentParty$playbac2 === void 0 ? void 0 : _currentParty$playbac2.is_playing); //undefined\n\n      const isNewSong = (currentParty === null || currentParty === void 0 ? void 0 : (_currentParty$playbac3 = currentParty.playbackState) === null || _currentParty$playbac3 === void 0 ? void 0 : _currentParty$playbac3.item.id) !== party.playbackState.item.id; //false\n\n      console.log(isNowPlaying, isNowPaused, isNewSong);\n\n      if (isNowPlaying || isNewSong) {\n        playSong(party.playbackState);\n      } else if (isNowPaused) {\n        pauseSong();\n      }\n    }\n\n    setCurrentParty(party);\n  };\n\n  const onNewUserJoined = party => {\n    var _party$users;\n\n    console.log('New user joined,', party.users ? party.users[((_party$users = party.users) === null || _party$users === void 0 ? void 0 : _party$users.length) - 1].display_name : '');\n    setCurrentParty(party);\n  };\n\n  const onPartyNotFound = () => {\n    console.log('This party was not found... redirecting back');\n    setTimeout(() => {\n      history.push('/');\n    }, 2000);\n  };\n\n  const onPartyJoined = party => {\n    setCurrentParty(party);\n\n    if (party.playbackState && party.playbackState.is_playing) {\n      playSong(party.playbackState, true);\n    }\n  };\n\n  const onAdminChanged = party => {\n    var _party$adminUser2;\n\n    clearInterval(pollCurrentlyPlaying);\n\n    if (((_party$adminUser2 = party.adminUser) === null || _party$adminUser2 === void 0 ? void 0 : _party$adminUser2.id) === (user === null || user === void 0 ? void 0 : user.id)) {\n      console.log('Youve been assigned admin.');\n      pollCurrentlyPlaying = setInterval(() => {\n        getCurrentlyPlaying(party.id);\n      }, 5000);\n    }\n\n    setCurrentParty(party);\n  };\n\n  const handleUserLeaving = () => {\n    socket.off(SocketEvent.USER_LEFT_PARTY_RES, onUserLeftParty);\n    socket.off(SocketEvent.PARTY_PLAYBACK_CHANGED_RES, onPlaybackChanged);\n    socket.off(SocketEvent.PARTY_NOT_FOUND_RES, onPartyNotFound);\n    socket.off(SocketEvent.PARTY_NEW_USER_JOINED_RES, onNewUserJoined);\n    socket.off(SocketEvent.PARTY_JOINED_RES, onPartyJoined);\n    socket.off(SocketEvent.PARTY_CHANGED_ADMIN_RES, onAdminChanged);\n    console.log('Leaving party.');\n    clearInterval(pollCurrentlyPlaying);\n    socket.emit(SocketEvent.USER_LEFT_PARTY_REQ);\n  };\n\n  const playSong = (playbackState, isFirstTime = false) => {\n    console.log('setting currently playing...', playbackState);\n    const args = {\n      uris: [playbackState.item.uri],\n      position_ms: isFirstTime ? playbackState.progress_ms : 0\n    };\n    console.log(args);\n    axios.put(SPOTIFY_API.PLAY, args).then(() => console.log('Playing new song: ', playbackState.item.name)).catch(err => {\n      const error = err.response.data.error;\n\n      if (error.reason === \"NO_ACTIVE_DEVICE\") {\n        console.log('Could not play song. No active device found.');\n      } else if (error.reason === \"PREMIUM_REQUIRED\") {\n        console.log('Could not play song. Premium required.');\n      } else {\n        console.log('Could not play song. Error: ', error);\n      }\n    });\n  };\n\n  const pauseSong = () => {\n    axios.put(SPOTIFY_API.PAUSE).then(() => console.log('Paused song.')).catch(err => {\n      const error = err.response.data.error;\n      console.log('Could not pause song: ', error);\n    });\n  };\n\n  const getCurrentlyPlaying = partyId => {\n    console.log('Getting currently playing...');\n    axios.get(SPOTIFY_API.CURRENTLY_PLAYING).then(res => {\n      if (!res.data || !res.data.item) {\n        console.log('Nothing is playing, its an ad, or you are in private mode.');\n        return;\n      }\n\n      socket.emit(SocketEvent.PARTY_PLAYBACK_REQ, {\n        playbackState: res.data,\n        partyId: partyId\n      });\n    }).catch(err => {\n      console.log('could not get currently playing');\n    });\n  }; // const onPartyJoinedUnauthed = (numberOfUsers: number) => {\n  //     console.log('PARTY JOINED BACK')\n  //     setNumberOfUsers(numberOfUsers);\n  // }\n\n\n  console.log(currentParty);\n  return /*#__PURE__*/React.createElement(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 190,\n      columnNumber: 9\n    }\n  }, user && user.id ? /*#__PURE__*/React.createElement(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 192,\n      columnNumber: 17\n    }\n  }, /*#__PURE__*/React.createElement(\"h1\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 193,\n      columnNumber: 21\n    }\n  }, \"A duper dope party\"), /*#__PURE__*/React.createElement(\"h2\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 194,\n      columnNumber: 21\n    }\n  }, \"Hi, \", user.display_name, \"!\"), /*#__PURE__*/React.createElement(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 195,\n      columnNumber: 21\n    }\n  }, \"The DJ is \", currentParty === null || currentParty === void 0 ? void 0 : (_currentParty$adminUs = currentParty.adminUser) === null || _currentParty$adminUs === void 0 ? void 0 : _currentParty$adminUs.display_name), /*#__PURE__*/React.createElement(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 196,\n      columnNumber: 21\n    }\n  }, \"Users in party: \", currentParty === null || currentParty === void 0 ? void 0 : (_currentParty$users = currentParty.users) === null || _currentParty$users === void 0 ? void 0 : _currentParty$users.map(user => user.display_name).join(', ')), (currentParty === null || currentParty === void 0 ? void 0 : currentParty.playbackState) ? /*#__PURE__*/React.createElement(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 198,\n      columnNumber: 25\n    }\n  }, /*#__PURE__*/React.createElement(\"div\", {\n    className: \"song\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 199,\n      columnNumber: 29\n    }\n  }, \"Currently playing\"), /*#__PURE__*/React.createElement(\"h3\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 200,\n      columnNumber: 29\n    }\n  }, currentParty === null || currentParty === void 0 ? void 0 : (_currentParty$playbac4 = currentParty.playbackState) === null || _currentParty$playbac4 === void 0 ? void 0 : _currentParty$playbac4.item.name), /*#__PURE__*/React.createElement(\"h3\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 201,\n      columnNumber: 29\n    }\n  }, currentParty === null || currentParty === void 0 ? void 0 : (_currentParty$playbac5 = currentParty.playbackState) === null || _currentParty$playbac5 === void 0 ? void 0 : _currentParty$playbac5.item.album.artists[0].name), /*#__PURE__*/React.createElement(\"img\", {\n    style: imageStyle,\n    src: currentParty.playbackState.item.album.images[0].url,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 202,\n      columnNumber: 29\n    }\n  }), /*#__PURE__*/React.createElement(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 203,\n      columnNumber: 29\n    }\n  }, currentParty.playbackState.is_playing ? 'Playing' : 'Paused')) : /*#__PURE__*/React.createElement(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 206,\n      columnNumber: 25\n    }\n  }, \"No tracks playing\")) : /*#__PURE__*/React.createElement(\"div\", {\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 210,\n      columnNumber: 17\n    }\n  }, \"This is a party, but you aint authed.\"));\n};\n\nexport default PartyPage;","map":{"version":3,"sources":["/Users/max/dev/listening-party/client/src/pages/Party.tsx"],"names":["React","useEffect","useState","SocketEvent","axios","useHistory","useUser","socket","SPOTIFY_API","imageStyle","width","height","PartyPage","match","user","isLoading","currentParty","setCurrentParty","undefined","partyId","params","id","history","pollCurrentlyPlaying","handleUserLeaving","registerListeners","on","USER_LEFT_PARTY_RES","onUserLeftParty","PARTY_PLAYBACK_CHANGED_RES","onPlaybackChanged","PARTY_NOT_FOUND_RES","onPartyNotFound","PARTY_NEW_USER_JOINED_RES","onNewUserJoined","PARTY_JOINED_RES","onPartyJoined","PARTY_CHANGED_ADMIN_RES","onAdminChanged","console","log","display_name","emit","PARTY_JOINED_REQ","socketId","party","isAdminUser","adminUser","playbackState","isNowPlaying","is_playing","isNowPaused","isNewSong","item","playSong","pauseSong","users","length","setTimeout","push","clearInterval","setInterval","getCurrentlyPlaying","off","USER_LEFT_PARTY_REQ","isFirstTime","args","uris","uri","position_ms","progress_ms","put","PLAY","then","name","catch","err","error","response","data","reason","PAUSE","get","CURRENTLY_PLAYING","res","PARTY_PLAYBACK_REQ","map","join","album","artists","images","url"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react';\nimport { useLocation } from 'react-router-dom';\nimport io from 'socket.io-client'\nimport { SocketEvent, Party, PlaybackState } from '../common';\nimport axios, { AxiosResponse } from 'axios';\nimport Button from '../components/Button';\nimport { getHashParams } from '../helpers/helpers';\nimport { withRouter, match, useHistory } from 'react-router';\n\nimport { useUser } from '../contexts/UserContext';\nimport socket from '../socket';\nimport { User } from '../common';\nimport { SPOTIFY_API } from '../const';\n\ninterface Props {\n    match: any;\n}\n\nconst imageStyle = {\n    width: '100vw',\n    height: 'auto'\n}\n\nconst PartyPage: React.FC<Props> = ({ match }): React.ReactElement => {\n    const { user, isLoading } = useUser();\n    const [currentParty, setCurrentParty] = useState<Party | undefined>(undefined);\n    const partyId = match.params.id;\n    const history = useHistory();\n    let pollCurrentlyPlaying: any;\n\n    useEffect(() => {\n        // NEED TO CHECK IF PARTY EXISTS HERE \n        return () => handleUserLeaving();\n    }, [])\n\n    const registerListeners = () => {\n        socket.on(SocketEvent.USER_LEFT_PARTY_RES, onUserLeftParty);\n        socket.on(SocketEvent.PARTY_PLAYBACK_CHANGED_RES, onPlaybackChanged);\n        socket.on(SocketEvent.PARTY_NOT_FOUND_RES, onPartyNotFound);\n        socket.on(SocketEvent.PARTY_NEW_USER_JOINED_RES, onNewUserJoined);\n        socket.on(SocketEvent.PARTY_JOINED_RES, onPartyJoined);\n        socket.on(SocketEvent.PARTY_CHANGED_ADMIN_RES, onAdminChanged);\n    }\n\n    useEffect(() => {\n        console.log('user useEffect');\n        if (!user || isLoading) {\n            if (!isLoading) {\n                console.log('You are not authed');\n            }\n            return;\n        }\n\n        console.log('Logged in as ', user.display_name);\n\n        registerListeners();\n        socket.emit(SocketEvent.PARTY_JOINED_REQ, { user: user, socketId: socket.id, partyId: partyId })\n    }, [user])\n\n\n\n    const onUserLeftParty = (party: Party) => {\n        console.log('A user left party.');\n        setCurrentParty(party);\n    }\n\n    const onPlaybackChanged = (party: Party) => {\n        console.log('Playback state changed.');\n        const isAdminUser = party.adminUser?.id === user?.id;\n        if (!isAdminUser && party.playbackState) {\n\n            console.log(currentParty?.playbackState);\n            console.log(party.playbackState);\n\n            const isNowPlaying = party.playbackState.is_playing && !currentParty?.playbackState?.is_playing; //false\n            const isNowPaused = !party.playbackState.is_playing && currentParty?.playbackState?.is_playing;//undefined\n            const isNewSong = currentParty?.playbackState?.item.id !== party.playbackState.item.id; //false\n\n            console.log(isNowPlaying, isNowPaused, isNewSong);\n\n            if (isNowPlaying || isNewSong) {\n                playSong(party.playbackState);\n            } else if (isNowPaused) {\n                pauseSong();\n            }\n        }\n\n        setCurrentParty(party);\n    }\n\n    const onNewUserJoined = (party: Party) => {\n        console.log('New user joined,', party.users ? party.users[party.users?.length - 1].display_name : '');\n        setCurrentParty(party);\n    }\n\n    const onPartyNotFound = () => {\n        console.log('This party was not found... redirecting back');\n        setTimeout(() => {\n            history.push('/');\n        }, 2000);\n    }\n\n    const onPartyJoined = (party: Party) => {\n        setCurrentParty(party);\n        if (party.playbackState && party.playbackState.is_playing) {\n            playSong(party.playbackState, true);\n        }\n    }\n\n    const onAdminChanged = (party: Party) => {\n        clearInterval(pollCurrentlyPlaying);\n        if (party.adminUser?.id === user?.id) {\n            console.log('Youve been assigned admin.')\n            pollCurrentlyPlaying = setInterval(() => {\n                getCurrentlyPlaying(party.id);\n            }, 5000);\n        }\n        setCurrentParty(party);\n    }\n\n    const handleUserLeaving = () => {\n        socket.off(SocketEvent.USER_LEFT_PARTY_RES, onUserLeftParty);\n        socket.off(SocketEvent.PARTY_PLAYBACK_CHANGED_RES, onPlaybackChanged);\n        socket.off(SocketEvent.PARTY_NOT_FOUND_RES, onPartyNotFound);\n        socket.off(SocketEvent.PARTY_NEW_USER_JOINED_RES, onNewUserJoined);\n        socket.off(SocketEvent.PARTY_JOINED_RES, onPartyJoined);\n        socket.off(SocketEvent.PARTY_CHANGED_ADMIN_RES, onAdminChanged);\n\n        console.log('Leaving party.')\n\n        clearInterval(pollCurrentlyPlaying);\n        socket.emit(SocketEvent.USER_LEFT_PARTY_REQ)\n    }\n\n    const playSong = (playbackState: PlaybackState, isFirstTime = false) => {\n        console.log('setting currently playing...', playbackState);\n\n        const args = {\n            uris: [playbackState.item.uri],\n            position_ms: isFirstTime ? playbackState.progress_ms : 0\n        }\n        console.log(args);\n        axios.put(SPOTIFY_API.PLAY, args)\n            .then(() => console.log('Playing new song: ', playbackState.item.name))\n            .catch(err => {\n                const error = err.response.data.error;\n                if (error.reason === \"NO_ACTIVE_DEVICE\") {\n                    console.log('Could not play song. No active device found.')\n                } else if (error.reason === \"PREMIUM_REQUIRED\") {\n                    console.log('Could not play song. Premium required.')\n                } else {\n                    console.log('Could not play song. Error: ', error);\n                }\n            });\n    }\n\n    const pauseSong = () => {\n        axios.put(SPOTIFY_API.PAUSE)\n            .then(() => console.log('Paused song.'))\n            .catch(err => {\n                const error = err.response.data.error;\n                console.log('Could not pause song: ', error)\n            });\n    }\n\n    const getCurrentlyPlaying = (partyId: string) => {\n        console.log('Getting currently playing...');\n        axios.get(SPOTIFY_API.CURRENTLY_PLAYING)\n            .then((res: AxiosResponse<PlaybackState>) => {\n                if (!res.data || !res.data.item) {\n                    console.log('Nothing is playing, its an ad, or you are in private mode.');\n                    return;\n                }\n                socket.emit(SocketEvent.PARTY_PLAYBACK_REQ, { playbackState: res.data, partyId: partyId })\n            })\n            .catch(err => { console.log('could not get currently playing') })\n    }\n\n\n\n\n    // const onPartyJoinedUnauthed = (numberOfUsers: number) => {\n    //     console.log('PARTY JOINED BACK')\n    //     setNumberOfUsers(numberOfUsers);\n    // }\n\n    console.log(currentParty);\n\n    return (\n        <div>\n            {user && user.id ?\n                <div>\n                    <h1>A duper dope party</h1>\n                    <h2>Hi, {user.display_name}!</h2>\n                    <div>The DJ is {currentParty?.adminUser?.display_name}</div>\n                    <div>Users in party: {currentParty?.users?.map(user => user.display_name).join(', ')}</div>\n                    {currentParty?.playbackState ?\n                        <div>\n                            <div className=\"song\">Currently playing</div>\n                            <h3>{currentParty?.playbackState?.item.name}</h3>\n                            <h3>{currentParty?.playbackState?.item.album.artists[0].name}</h3>\n                            <img style={imageStyle} src={currentParty.playbackState.item.album.images[0].url}></img>\n                            <div>{currentParty.playbackState.is_playing ? 'Playing' : 'Paused'}</div>\n                        </div>\n                        :\n                        <div>No tracks playing</div>\n                    }\n                </div>\n                :\n                <div>This is a party, but you aint authed.</div>}\n        </div>);\n\n};\n\nexport default PartyPage;\n"]},"metadata":{},"sourceType":"module"}